<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>The continuous behavior of train:</title>

<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 12px;
   margin: 8px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 { 
   font-size:2.2em; 
}

h2 { 
   font-size:1.8em; 
}

h3 { 
   font-size:1.4em; 
}

h4 { 
   font-size:1.0em; 
}

h5 { 
   font-size:0.9em; 
}

h6 { 
   font-size:0.8em; 
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre {	
   margin-top: 0;
   max-width: 95%;
   border: 1px solid #ccc;
   white-space: pre-wrap;
}

pre code {
   display: block; padding: 0.5em;
}

code.r, code.cpp {
   background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * { 
      background: transparent !important; 
      color: black !important; 
      filter:none !important; 
      -ms-filter: none !important; 
   }

   body { 
      font-size:12pt; 
      max-width:100%; 
   }
       
   a, a:visited { 
      text-decoration: underline; 
   }

   hr { 
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote { 
      padding-right: 1em; 
      page-break-inside: avoid; 
   }

   tr, img { 
      page-break-inside: avoid; 
   }

   img { 
      max-width: 100% !important; 
   }

   @page :left { 
      margin: 15mm 20mm 15mm 10mm; 
   }
     
   @page :right { 
      margin: 15mm 10mm 15mm 20mm; 
   }

   p, h2, h3 { 
      orphans: 3; widows: 3; 
   }

   h2, h3 { 
      page-break-after: avoid; 
   }
}

</style>





</head>

<body>
<p>We have four trains and four subway stations. The train runs from Station-1 to Station-4, then from Station-4 to Station-1, and so on. Station-1 and Station-4 are the first station and final station, respectively. The train will reach the final station in direction A, and stopped at platform A. After several minutes, it will leave from platform A to platform B. And, its direction will be changed from direction A to direction B, and the train will stop at platform B. Similarly, at the first station, the train will change
the direction from B to A.</p>

<p>The positions of these four stations are:</p>

<div align="center">
<table width="80%" border="1">
<thead>
<tr>
  <th>Station</th>
  <th>Position (m)</th>
</tr>
</thead>
<tbody align="center">
<tr >
  <td>Station-1</td>
  <td>0</td>
</tr>
<tr>
  <td>Station-2</td>
  <td>2284</td>
</tr>
<tr>
  <td>Station-3</td>
  <td>3292</td>
</tr>
<tr>
  <td>Station-4</td>
  <td>9097</td>
</tr>
</tbody>
</table>
</div>

<p><br></p>

<p>The subway line is depicted as:</p>

<p><img src="%7B%7B%20BASE_PATH%20%7D%7D/assets/figs/sbwl.jpg" alt="Subway Line"/></p>

<p>The structure of the model of subway control system:</p>

<div style="text-align:center" markdown="1">

![Model Structure]({{ BASE_PATH }}/assets/figs/systemstructure.jpg)

</div>

<h4>The continuous behavior of train:</h4>

<pre><code>package model.train;
import com.fofo.apricot.Dynamic;
class TrainBehavior implements Dynamic{

    Real pos;
    Real vel;
    Int dir;    
    real acc;//acceleration

    real pos1; 
    real pos2;
    real vel1;
    real vel2;

    TrainBehavior(Real pos, Real vel, Int dir){

    }

    void setAcceleration(real acc){
        this.acc = acc;
    }

    void setPosVelBound(real pos1, real pos2, real vel1, real vel2){
        this.pos1 = pos1;
        this.pos2 = pos2;
        this.vel1 = vel1;
        this.vel2 = vel2;
    }


    void Continuous(){
        dot(pos,1) == dir*vel;
        dot(vel,1) == acc;                              
    }

    Invariant{
        pos in [pos1,pos2]; // the limitation can be set in an Assignment
        vel in [vel1,vel2];     
    };

}
</code></pre>

<h4>The class declaration of train:</h4>

<pre><code>package model.train;
import com.fofo.apricot.*;
import model.doorsystem.TrainDoorController;
import model.doorsystem.DoorSystem;  
import model.train.TrainBehavior;
import model.Wait;
import model.utility.Configure;
import model.utility.Physics;
class Train implements Plant{       

    // add dynamics and controllers 
    Constant int traindooramount = 3;
    Constant int len = 2; // the length of a door, 2 m.
    Constant int vel = 1; // the velocity of opening a door, 1 m/s.
    real S;// position of station

    DoorSystem tds = new DoorSystem(traindooramount, new TrainDoorController(), len, vel);
    Controller trainController;

    Real position;
    Real velocity;
    Int direction;
    real DELAY;
    int index;//the index for stations  
    Configure cfg;
    Physics phy;
    private real maxpos;

    //Dynamics :
    Wait init = new Wait([0,DELAY]);
    Wait stopAtStation = new Wait([0,Inf]);
    Wait changeDirection = new Wait([0,30]);
    TrainBehavior run = createBaseDynamics(0.5);
    TrainBehavior near = createBaseDynamics(0);
    TrainBehavior stablerun = createBaseDynamics(0);
    TrainBehavior urgent_dec = createBaseDynamic(-1.5);
    TrainBehavior urgent_stop = createBaseDynamics(0);
    TrainBehavior urgent_inc = createBaseDynamics(0.5);
    TrainBehavior urgent_recover = createBaseDynamics(-0.5);


    void Composition(){
        //from init
        stop()(init,,stopAtStation){
            Condition{
                init.getTime() == DELAY;    
            };
            Discrete{   
                stopAtStation.reset();              
            };
        }

        //from stopAtStation
        start()(stopAtStation,,changeDirection){
            Condition{
                (index==0 and direction==-1)
                or
                (index==getStationAmount() and direction==1);
            };
            Discrete{
                changeDirection.reset();    
            };
        }

        start()(stopAtStation,,run){
            Condition{
                (index&gt;0 and direction==-1)
                or
                (index&lt;getStationAmount()-1 and direction==1);
            };
            Discrete{
                index = index + direction;
                //S refers to the target station&#39;s position
                S = cfg.getStationPosOf(index);
                this.setPosVelBound(run);
            };
        }

        //from changeDirection
        stop()(changeDirection,,stopAtStation){
            Condition{
                changeDirection.getTime() == 30;
            };
            Discrete{
                resetDirection();   
                stopAtStation.reset();
            };
        }


        //from run or stablerun to near
        tau({run, stablerun},,near){
            Condition{
                abs(S-position) &lt;= 500; 
            };
            Discrete{
                near.setAcceleration(
                    phy.calAccFromVelAndDis(velocity, abs(S-position))
                );  
            };
        }

        tau(run,,stablerun){
            Condition{
                velocity == 20;
            };
            Discrete{
                stablerun.setAcceleration(0);
                this.setPosVelBoundWithParas(stablerun,S,500,20,20);
            };
        }

        //from near or urgent_recover
        stop()({near,urgent_recover},,stopAtStation){
            Condition{
                abs(S-position) &lt;= 1;  
                velocity in [0, 0.1];
            };
            Discrete{
                velocity = 0;
                position = S;
                stopAtStation.reset();
            };
        }

        urStop(?)( {stablerun, run , near, urgent_inc, urgent_recover}, , urgent_dec){
            Condition{
                true;
            };
            Discrete{
                this.setPosVelBoundWithParas(urgent_dec,S,0,0,20);
            };
        }

        Train_Urstopped(urgent_dec,, urgent_stop){
            Condition{
                velocity &lt;= 0.1;
            };
            Discrete{
                velocity = 0;
                this.setPosVelBoundWithParas(urgent_stop, S, 0, 0, 0);
            };          
        }

        urStart(?)(urgent_stop,,urgent_inc){
            Condition{
                abs(S-position) &lt;= 800;
            };      
            Discrete{
                maxpos = 0.5*(S+position);
                this.setPosVelBoundWithParas(urgent_stop, maxpos, 0, 0, 20);
            };
        }

        urStart(?)(urgent_stop,,run){
            Condition{
                abs(S-position) &gt; 800;
            };      
            Discrete{               
                this.setPosVelBoundWithParas(run, S, 500, 0, 20);
            };
        }

        tau(urgent_inc,,urgent_recover){
            Condition{
                position == maxp;
            };      
            Discrete{               
                this.setPosVelBoundWithParas(urgent_recover, S, -1, 0, 20);
            };
        }       
    }

    void setPosVelBound(TrainBehavior tb){
        this.setPosVelBoundWithParas(tb, S, 500, 0, 20);
    }

    void setPosVelBoundWithParas
        (TrainBehavior tb, real target, real diff, real fromv, real tov){
        if (direction==1){
            tb.setPosVelBound(-Inf,target-diff,fromv,tov);
        }
        else{
            tb.setPosVelBound(target+diff,Inf,fromv,tov);
        }
    }

    void resetDirection(){
        this.direction = -1 * this.direction;
    }

    void setDelay(real delay){
        this.DELAY = delay;
    }

    int getStationAmount(){
        return cfg.getStationAmount();
    }

    //create dynamics only with acceleration
    Dynamic createBaseDynamics(real acceleration){
        TrainBehavior 
        dy = new TrainBehavior(this.position, this.velocity, this.direction);
        dy.setAcceleration(acceleration);
        return dy;
    }

    //create dynamics with acceleration and boundaries
    Dynamic createDynamics
        (real acceleration, real fromPos, real toPos, real fromVel, real toVel){
        TrainBehavior dy = createBaseDynamics(acceleration);
        dy.setPosVelBound(fromPos,toPos,fromVel,toVel);
        return dy; 
    }
}
</code></pre>

<pre class="prettyprint">
    Code
</pre>

<script type="text/javascript" src="jquery-1.10.2.min.js"></script>

<script src="prettify.js" type="text/javascript"></script>

<p>{% include JB/setup %}</p>

</body>

</html>

